<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨å®¶èº«é«”ç´€éŒ„ 2026 ğŸ¾</title>
    
    <!-- PWA æ¡Œé¢åŒ–é—œéµæ¨™ç±¤ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶æ—å¥åº·">
    <meta name="theme-color" content="#fdfcf0">
    
    <!-- åŸºç¤å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- åœ–è¡¨èˆ‡åœ–ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- å·¥å…·åº« -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥åœ“æ½¤å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+TC:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-cat: #fdfcf0;
            --accent-warm: #ffb4a2;
            --cat-brown: #6d597a;
            --soft-pink: #ffcdb2;
        }

        /* çµ•å°å¼·åˆ¶ï¼šå…¨åŸŸå­—é«”ä¸€è‡´ã€åœ“æ½¤è¦–è¦º */
        * {
            font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif !important;
            font-weight: 400 !important;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-cat);
            color: var(--cat-brown);
            margin: 0;
            padding: 0;
            font-size: 18px; 
            overscroll-behavior-y: contain;
        }

        h1, h2, h3, h4, b, strong, button, span, div, p, input, textarea, select {
            font-weight: 400 !important;
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-cat); }
        ::-webkit-scrollbar-thumb { background: var(--soft-pink); border-radius: 10px; }
        
        /* è²“è€³æœµè£é£¾ */
        .cat-ears::before, .cat-ears::after {
            content: '';
            position: absolute;
            top: -20px;
            width: 40px;
            height: 30px;
            background: white;
            border: 4px solid white;
            border-radius: 50% 50% 0 0;
            z-index: -1;
        }
        .cat-ears::before { left: 30px; transform: rotate(-15deg); border-top-left-radius: 100px; }
        .cat-ears::after { right: 30px; transform: rotate(15deg); border-top-right-radius: 100px; }

        @keyframes purr {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .animate-purr { animation: purr 3s infinite ease-in-out; }
        
        .modal-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
        }
        input[type="color"]::-webkit-color-swatch { border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .cat-card {
            background: white;
            border-radius: 2.5rem;
            box-shadow: 0 10px 30px -10px rgba(109, 89, 122, 0.1);
            transition: all 0.3s ease;
        }
        .cat-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FirebaseSDK = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, deleteDoc, query };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment, useRef } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = window.Recharts;

        // è²“è²“é ­åƒ SVG
        const CatHead = ({ color = "#6d597a", size = 40 }) => (
            <svg width={size} height={size} viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M40 80L20 20L80 50C90 45 110 45 120 50L180 20L160 80C180 100 180 140 160 160C140 180 60 180 40 160C20 140 20 100 40 80Z" fill="white" stroke={color} strokeWidth="8" />
                <circle cx="70" cy="110" r="10" fill={color} />
                <circle cx="130" cy="110" r="10" fill={color} />
                <path d="M90 130C100 140 110 130 110 130" stroke={color} strokeWidth="6" strokeLinecap="round" />
                <path d="M100 130L100 120" stroke={color} strokeWidth="6" strokeLinecap="round" />
            </svg>
        );

        const Icon = ({ name, size = 28, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    i.setAttribute('data-lucide', kebabName);
                    containerRef.current.appendChild(i);
                    window.lucide.createIcons({
                        elements: [i],
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        const firebaseConfig = {
            apiKey: "AIzaSyCMo1zj-zXLtwGd1WFtISt_O6ku8pmZOMc",
            authDomain: "health-86609.firebaseapp.com",
            projectId: "health-86609",
            storageBucket: "health-86609.firebasestorage.app",
            messagingSenderId: "969606507760",
            appId: "1:969606507760:web:2223db1994907d1c97a635",
            measurementId: "G-Q1VYJQVRBF"
        };

        const MONTH_NAMES = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
        const WEEKDAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [records, setRecords] = useState([]);
            const [members, setMembers] = useState([]);
            
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [isInstallModalOpen, setIsInstallModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [editingRecord, setEditingRecord] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            const [newMemberForm, setNewMemberForm] = useState({ name: '', color: '#ffb4a2' });
            const [formData, setFormData] = useState({ memberId: '', hospital: '', department: '', problem: '', systolic: '', diastolic: '', heartRate: '', weight: '', medication: '', frequency: '' });

            const appId = 'health-diary-cat-v2026';

            useEffect(() => {
                const initFirebase = () => {
                    if (window.FirebaseSDK) {
                        const app = window.FirebaseSDK.initializeApp(firebaseConfig);
                        const firestore = window.FirebaseSDK.getFirestore(app);
                        const fireauth = window.FirebaseSDK.getAuth(app);
                        setDb(firestore);
                        setAuth(fireauth);
                        window.FirebaseSDK.onAuthStateChanged(fireauth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const qRecords = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
                const unsubRecords = window.FirebaseSDK.onSnapshot(qRecords, (snapshot) => {
                    setRecords(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const qMembers = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'members');
                const unsubMembers = window.FirebaseSDK.onSnapshot(qMembers, (snapshot) => {
                    const memberList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (snapshot.empty) {
                        const initDefault = async () => {
                            const ref = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'members');
                            await window.FirebaseSDK.addDoc(ref, { name: 'çˆ¸çˆ¸', color: '#bae6fd' });
                            await window.FirebaseSDK.addDoc(ref, { name: 'åª½åª½', color: '#fbcfe8' });
                        };
                        initDefault();
                    } else {
                        setMembers(memberList);
                        if (!formData.memberId && memberList.length > 0) {
                            setFormData(prev => ({ ...prev, memberId: memberList[0].id }));
                        }
                    }
                });
                return () => { unsubRecords(); unsubMembers(); };
            }, [user, db, formData.memberId]);

            const login = async () => {
                const provider = new window.FirebaseSDK.GoogleAuthProvider();
                try { await window.FirebaseSDK.signInWithPopup(auth, provider); } catch (err) { alert(err.message); }
            };

            const addMember = async () => {
                if (!newMemberForm.name.trim()) return;
                const ref = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'members');
                await window.FirebaseSDK.addDoc(ref, newMemberForm);
                setNewMemberForm({ name: '', color: '#ffb4a2' });
            };

            const deleteMember = async (id) => {
                if (window.confirm("è¦ç§»é™¤é€™ä½æˆå“¡å—ï¼Ÿç´€éŒ„æœƒä¿ç•™å–”ï¼")) {
                    await window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'members', id));
                }
            };

            const updateMember = async (id, field, value) => {
                const ref = window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'members', id);
                await window.FirebaseSDK.setDoc(ref, { [field]: value }, { merge: true });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSaving || !formData.memberId) return;
                setIsSaving(true);
                try {
                    const path = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
                    const data = { ...formData, date: selectedDate, updatedAt: new Date().toISOString() };
                    if (editingRecord) await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', editingRecord.id), data);
                    else await window.FirebaseSDK.addDoc(path, data);
                    setIsModalOpen(false);
                } catch (error) { alert("å„²å­˜å¤±æ•—ï¼š " + error.message); } finally { setIsSaving(false); }
            };

            const exportToCSV = () => {
                if (records.length === 0) return;
                const headers = ["æ—¥æœŸ", "æˆå“¡", "é†«é™¢", "ç§‘åˆ¥", "æè¿°", "æ”¶ç¸®å£“", "èˆ’å¼µå£“", "å¿ƒè·³", "é«”é‡", "è—¥å“", "é »ç‡"];
                const csvRows = [headers, ...records.map(r => {
                    const mName = members.find(m => m.id === r.memberId)?.name || "æœªçŸ¥";
                    return [r.date, mName, r.hospital || "", r.department || "", (r.problem || "").replace(/\n/g, " "), r.systolic || "", r.diastolic || "", r.heartRate || "", r.weight || "", r.medication || "", r.frequency || ""];
                })];
                const blob = new Blob(["\ufeff" + csvRows.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n")], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `è²“è²“å¥åº·å ±è¡¨_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = new Date(year, month, 1).getDay();

            const chartData = useMemo(() => {
                return Array.from({ length: daysInMonth }, (_, i) => {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`;
                    const dayObj = { displayDate: `${month + 1}/${i + 1}` };
                    records.filter(r => r.date === dateStr).forEach(r => {
                        const mid = r.memberId;
                        if (r.systolic) dayObj[`${mid}_systolic`] = parseFloat(r.systolic);
                        if (r.diastolic) dayObj[`${mid}_diastolic`] = parseFloat(r.diastolic);
                        if (r.heartRate) dayObj[`${mid}_heartRate`] = parseFloat(r.heartRate);
                        if (r.weight) dayObj[`${mid}_weight`] = parseFloat(r.weight);
                    });
                    return dayObj;
                });
            }, [records, month, year, daysInMonth]);

            if (loading) return null;

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-8 bg-[#fdfcf0]">
                        <div className="bg-white rounded-[4rem] border-8 border-[#ffcdb2] p-12 text-center max-w-xl w-full shadow-2xl animate-purr relative">
                            <div className="absolute -top-12 left-1/2 -translate-x-1/2"><CatHead size={100} color="#ffb4a2" /></div>
                            <h1 className="text-4xl text-[#6d597a] mt-8 mb-4 font-bold tracking-tight">å®¶æ—ç´€éŒ„ ğŸ¾</h1>
                            <p className="text-[#b5838d] mb-10 text-xl">è«‹ç™»å…¥ Google<br/>é–‹å•Ÿæ‚¨çš„æº«é¦¨å®¶æ—ç©ºé–“</p>
                            <button onClick={login} className="w-full py-6 bg-[#ffb4a2] text-white rounded-full text-2xl hover:bg-[#e5989b] transition-all flex items-center justify-center gap-4 shadow-xl active:scale-95">
                                <Icon name="Cat" size={36} /> ç™»å…¥å°çª©
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24">
                    {/* é ‚éƒ¨è²“è²“å°èˆª */}
                    <header className="sticky top-0 z-30 px-6 py-4 bg-white/80 backdrop-blur-lg border-b-4 border-[#ffcdb2] flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <CatHead size={48} color="#6d597a" />
                            <h1 className="text-2xl hidden md:block font-bold">å¥åº·ç´€éŒ„çª©</h1>
                        </div>
                        
                        <div className="flex items-center gap-2 sm:gap-4 bg-white/50 rounded-full p-1">
                            <button onClick={() => setIsSettingsModalOpen(true)} className="p-3 hover:bg-[#ffcdb2]/20 rounded-full transition-all text-[#6d597a]">
                                <Icon name="Users" size={28} />
                            </button>
                            <button onClick={exportToCSV} className="p-3 hover:bg-[#ffcdb2]/20 rounded-full transition-all text-[#6d597a]">
                                <Icon name="FileDown" size={28} />
                            </button>
                            <button onClick={() => setIsInstallModalOpen(true)} className="p-3 hover:bg-[#ffcdb2]/20 rounded-full transition-all text-[#6d597a]">
                                <Icon name="Smartphone" size={28} />
                            </button>
                        </div>

                        <div className="flex items-center gap-4 bg-[#fdfcf0] rounded-full px-5 py-2 border-2 border-[#ffcdb2] shadow-sm">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="text-[#b5838d]"><Icon name="ChevronLeft" /></button>
                            <span className="text-xl min-w-[100px] text-center font-bold tracking-tighter">{year} / {MONTH_NAMES[month]}</span>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="text-[#b5838d]"><Icon name="ChevronRight" /></button>
                        </div>
                        
                        <button onClick={() => window.FirebaseSDK.signOut(auth)} className="p-3 text-[#6d597a] opacity-50 hover:opacity-100"><Icon name="LogOut" size={24} /></button>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 sm:p-8 space-y-12">
                        
                        {/* è—¥ç®±æ‘˜è¦ */}
                        <section className="relative">
                            <div className="flex items-center gap-3 mb-6 px-4">
                                <Icon name="Pill" className="text-[#ffb4a2]" /><h2 className="text-2xl font-bold">å®¶æ—æˆå“¡è—¥ç®± ğŸ’Š</h2>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                                {members.map(m => {
                                    const medRecords = records.filter(r => r.memberId === m.id && r.medication);
                                    return (
                                        <div key={m.id} className="cat-card p-8 border-t-8" style={{ borderTopColor: m.color }}>
                                            <div className="flex items-center justify-between mb-6">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-4 h-4 rounded-full" style={{ backgroundColor: m.color }}></div>
                                                    <span className="text-2xl font-bold tracking-tight">{m.name}</span>
                                                </div>
                                                <Icon name="Heart" className="text-[#ffcdb2]" size={20} />
                                            </div>
                                            <div className="space-y-4">
                                                {medRecords.length > 0 ? medRecords.slice(0, 3).map((med, idx) => (
                                                    <div key={idx} className="bg-[#fdfcf0] p-4 rounded-2xl border border-gray-100 shadow-sm">
                                                        <div className="text-[#6d597a] font-bold border-b border-white pb-2 mb-2">{med.medication}</div>
                                                        <div className="text-[#b5838d] text-sm font-medium italic">é »ç‡ï¼š{med.frequency || '--'}</div>
                                                    </div>
                                                )) : <p className="text-sm text-gray-300 italic py-4 text-center">ä¹–ä¹–æ²’åƒè—¥è—¥ ğŸƒ</p>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* æœˆæ›† */}
                        <section className="cat-card overflow-hidden border-8 border-white outline outline-4 outline-[#ffcdb2]/30">
                            <div className="grid grid-cols-7 bg-[#fdfcf0] border-b-2 border-dashed border-[#ffcdb2] text-[#b5838d] font-bold">
                                {WEEKDAYS.map(day => <div key={day} className="py-4 text-center text-sm">{day}</div>)}
                            </div>
                            <div className="grid grid-cols-7">
                                {[...Array(startingDay)].map((_, i) => <div key={`e-${i}`} className="min-h-[100px] bg-[#fdfcf0]/30 border-b border-r border-[#ffcdb2]/10" />)}
                                {[...Array(daysInMonth)].map((_, i) => {
                                    const d = i + 1;
                                    const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const dayRecs = records.filter(r => r.date === dStr);
                                    const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
                                    return (
                                        <div key={d} onClick={() => { setSelectedDate(dStr); setEditingRecord(null); setFormData(prev => ({ ...prev, hospital: '', department: '', problem: '', medication: '', frequency: '', systolic: '', diastolic: '', heartRate: '', weight: '' })); setIsModalOpen(true); }} 
                                            className="min-h-[110px] border-b border-r border-[#ffcdb2]/10 p-2 hover:bg-[#ffcdb2]/5 transition-all cursor-pointer group">
                                            <div className={`text-base w-9 h-9 flex items-center justify-center rounded-full mb-2 font-bold ${isToday ? 'bg-[#ffb4a2] text-white shadow-lg' : 'text-[#b5838d]'}`}>{d}</div>
                                            <div className="flex flex-col gap-1.5">
                                                {dayRecs.map(rec => {
                                                    const m = members.find(mem => mem.id === rec.memberId);
                                                    return (
                                                        <div key={rec.id} onClick={(e) => { e.stopPropagation(); setSelectedDate(rec.date); setEditingRecord(rec); setFormData(rec); setIsModalOpen(true); }} 
                                                            className="text-[10px] px-2 py-1 rounded-xl text-white truncate shadow-sm font-bold tracking-tight" 
                                                            style={{ backgroundColor: m?.color || '#6d597a' }}>
                                                            {rec.department || rec.hospital || 'ğŸ¾'}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* åœ–è¡¨åˆ†æ */}
                        <section className="space-y-10">
                            <div className="flex items-center gap-4 px-4 text-[#6d597a]"><Icon name="Activity" /><h2 className="text-2xl font-bold italic tracking-wide">å¥åº·å¤§æ•¸æ“š</h2><div className="flex-1 border-b-4 border-dotted border-[#ffcdb2]"></div></div>
                            <div className="cat-card p-10 h-[450px]">
                                <h3 className="text-xl mb-6 text-[#b5838d] font-bold flex items-center gap-2"><Icon name="Activity" size={24} /> è¡€å£“ç´€éŒ„ (å¯¦:æ”¶ç¸® / è™›:èˆ’å¼µ)</h3>
                                <ResponsiveContainer width="100%" height="90%">
                                    <LineChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffcdb2" />
                                        <XAxis dataKey="displayDate" style={{fontSize: '12px'}} />
                                        <YAxis width={40} domain={['dataMin - 10', 'dataMax + 10']} style={{fontSize: '12px'}} />
                                        <Tooltip contentStyle={{ borderRadius: '25px', border: '3px solid #ffcdb2', backgroundColor: '#fff', fontSize: '14px', padding: '15px' }} />
                                        {members.map(m => (
                                            <Fragment key={m.id}>
                                                <Line name={`${m.name} æ”¶ç¸®`} type="monotone" dataKey={`${m.id}_systolic`} stroke={m.color} strokeWidth={5} dot={{ r: 5, fill: '#fff', strokeWidth: 3 }} connectNulls />
                                                <Line name={`${m.name} èˆ’å¼µ`} type="monotone" dataKey={`${m.id}_diastolic`} stroke={m.color} strokeWidth={2} strokeDasharray="6 6" dot={{ r: 4 }} connectNulls />
                                            </Fragment>
                                        ))}
                                        <ReferenceLine y={140} stroke="#ffb4a2" strokeDasharray="8 8" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                                <div className="cat-card p-8 h-[380px]">
                                    <h3 className="text-lg mb-6 text-[#b5838d] font-bold">å¿ƒè·³å¿ƒå‹• (bpm)</h3>
                                    <ResponsiveContainer width="100%" height="80%">
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffcdb2" />
                                            <XAxis dataKey="displayDate" style={{fontSize: '10px'}} />
                                            <YAxis width={35} domain={[40, 120]} style={{fontSize: '10px'}} />
                                            {members.map(m => (<Line name={m.name} key={m.id} type="monotone" dataKey={`${m.id}_heartRate`} stroke={m.color} strokeWidth={5} dot={{ r: 5 }} connectNulls />))}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="cat-card p-8 h-[380px]">
                                    <h3 className="text-lg mb-6 text-[#b5838d] font-bold">é«”é‡æ§åˆ¶ (kg)</h3>
                                    <ResponsiveContainer width="100%" height="80%">
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#ffcdb2" />
                                            <XAxis dataKey="displayDate" style={{fontSize: '10px'}} />
                                            <YAxis width={35} domain={['auto', 'auto']} style={{fontSize: '10px'}} />
                                            {members.map(m => (<Line name={m.name} key={m.id} type="monotone" dataKey={`${m.id}_weight`} stroke={m.color} strokeWidth={5} dot={{ r: 5 }} connectNulls />))}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </section>
                    </main>

                    {/* æˆå“¡ç®¡ç† Modal */}
                    {isSettingsModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-[#6d597a]/40 backdrop-blur-md">
                            <div className="bg-white rounded-[4rem] w-full max-w-md p-10 shadow-2xl modal-fade-in border-8 border-white cat-ears relative">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-3xl font-bold text-[#6d597a]">æˆå“¡ç®¡ç†</h2>
                                    <button onClick={() => setIsSettingsModalOpen(false)} className="p-3 bg-[#fdfcf0] rounded-full text-[#ffcdb2]"><Icon name="X" /></button>
                                </div>
                                
                                <div className="p-6 bg-[#fdfcf0] rounded-[2.5rem] border-2 border-[#ffcdb2] mb-8 space-y-5">
                                    <div className="flex items-center gap-4">
                                        <input type="color" value={newMemberForm.color} onChange={e => setNewMemberForm({...newMemberForm, color: e.target.value})} />
                                        <input 
                                            type="text" 
                                            value={newMemberForm.name} 
                                            onChange={e => setNewMemberForm({...newMemberForm, name: e.target.value})}
                                            className="flex-1 px-5 py-3 bg-white rounded-2xl outline-none text-xl placeholder:text-gray-300" 
                                            placeholder="æ–°å¢åå­—..."
                                        />
                                        <button onClick={addMember} className="bg-[#ffb4a2] text-white p-3 rounded-full shadow-lg active:scale-90 transition-all"><Icon name="Plus" /></button>
                                    </div>
                                </div>

                                <div className="space-y-6 max-h-[350px] overflow-y-auto pr-3 no-scrollbar">
                                    {members.map(m => (
                                        <div key={m.id} className="p-6 bg-[#fdfcf0] rounded-3xl border-2 border-white shadow-sm flex items-center justify-between group">
                                            <div className="flex items-center gap-5">
                                                <input type="color" value={m.color} onChange={e => updateMember(m.id, 'color', e.target.value)} />
                                                <input 
                                                    type="text" 
                                                    value={m.name} 
                                                    onChange={e => updateMember(m.id, 'name', e.target.value)}
                                                    className="bg-transparent border-b-2 border-dashed border-gray-200 outline-none text-xl font-bold w-28 focus:border-[#ffb4a2]"
                                                />
                                            </div>
                                            <button onClick={() => deleteMember(m.id)} className="text-[#ffcdb2] hover:text-red-400 p-2 active:scale-125 transition-all">
                                                <Icon name="Trash2" size={24} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <p className="mt-8 text-center text-gray-300 text-sm italic font-medium">ğŸ¾ é»æ“Šè‰²å¡Šæˆ–æ–‡å­—å¯ç›´æ¥ä¿®æ”¹å–”ï¼</p>
                            </div>
                        </div>
                    )}

                    {/* å®‰è£æŒ‡å— Modal */}
                    {isInstallModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-[#6d597a]/40 backdrop-blur-md">
                            <div className="bg-white rounded-[4rem] w-full max-w-md p-10 shadow-2xl modal-fade-in border-8 border-white cat-ears relative">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-3xl font-bold text-[#6d597a]">å¸¶è²“è²“å»æ¡Œé¢</h2>
                                    <button onClick={() => setIsInstallModalOpen(false)} className="p-3 bg-[#fdfcf0] rounded-full text-[#ffcdb2]"><Icon name="X" /></button>
                                </div>
                                <div className="space-y-10 text-lg leading-relaxed font-medium">
                                    <div className="space-y-4">
                                        <p className="font-bold text-[#b5838d] border-b-4 border-dashed border-[#ffcdb2] pb-2 px-2">iPhone (Safari)</p>
                                        <ol className="list-decimal list-inside space-y-3 px-4">
                                            <li>é»æ“Šä¸‹æ–¹çš„ <Icon name="Share" size={22} className="inline mx-2 text-blue-400" /> åˆ†äº«</li>
                                            <li>é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ğŸ¾</li>
                                            <li>é»æ“Šå³ä¸Šè§’ã€Œæ–°å¢ã€</li>
                                        </ol>
                                    </div>
                                    <div className="space-y-4">
                                        <p className="font-bold text-[#b5838d] border-b-4 border-dashed border-[#ffcdb2] pb-2 px-2">Android (Chrome)</p>
                                        <ol className="list-decimal list-inside space-y-3 px-4">
                                            <li>é»æ“Šå³ä¸Šè§’ã€Œä¸‰å€‹é»ã€</li>
                                            <li>é»æ“Šã€Œæ–°å¢è‡³ä¸»ç•«é¢ã€ğŸ¾</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ•¸æ“šç´€éŒ„ Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#6d597a]/40 backdrop-blur-md">
                            <div className="bg-white rounded-[4rem] w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl border-8 border-white modal-fade-in cat-ears relative no-scrollbar">
                                <div className="p-8 sm:p-14">
                                    <div className="flex justify-between items-center mb-10">
                                        <div><h2 className="text-4xl font-bold text-[#6d597a]">èº«é«”ç­†è¨˜ ğŸ“’</h2><p className="text-[#b5838d] text-xl mt-2 tracking-widest font-bold">ğŸ¾ {selectedDate}</p></div>
                                        <button onClick={() => setIsModalOpen(false)} className="p-5 bg-[#fdfcf0] rounded-full text-[#ffcdb2] hover:rotate-90 transition-all shadow-sm"><Icon name="X" size={44} /></button>
                                    </div>
                                    
                                    <form onSubmit={handleSubmit} className="space-y-14">
                                        <div className="flex flex-wrap gap-4">
                                            {members.map(m => (
                                                <button key={m.id} type="button" onClick={() => setFormData({...formData, memberId: m.id})} 
                                                    className={`px-10 py-5 rounded-[2rem] border-4 text-2xl font-bold transition-all active:scale-95 ${formData.memberId === m.id ? 'shadow-xl scale-105' : 'bg-white text-gray-200 border-gray-100 opacity-50'}`}
                                                    style={formData.memberId === m.id ? { color: m.color, backgroundColor: `${m.color}15`, borderColor: m.color } : {}}>
                                                    {m.name}
                                                </button>
                                            ))}
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-14">
                                            <div className="space-y-10">
                                                <label className="block text-[#b5838d] font-bold text-xl px-2 italic">ğŸ©º å°±è¨ºæè¿°</label>
                                                <input type="text" value={formData.hospital} onChange={e => setFormData({...formData, hospital: e.target.value})} className="w-full px-8 py-6 bg-[#fdfcf0] rounded-[2.5rem] outline-none text-2xl border-2 border-transparent focus:border-[#ffcdb2] transition-all" placeholder="é†«é™¢åç¨±" />
                                                <input type="text" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} className="w-full px-8 py-6 bg-[#fdfcf0] rounded-[2.5rem] outline-none text-2xl border-2 border-transparent focus:border-[#ffcdb2] transition-all" placeholder="å°±è¨ºç§‘åˆ¥" />
                                                <textarea value={formData.problem} onChange={e => setFormData({...formData, problem: e.target.value})} className="w-full px-8 py-6 bg-[#fdfcf0] rounded-[2.5rem] outline-none h-48 text-2xl border-2 border-transparent focus:border-[#ffcdb2] transition-all" placeholder="å¯«ä¸‹èº«é«”ç‹€æ³..."></textarea>
                                            </div>
                                            
                                            <div className="space-y-12">
                                                <div className="bg-[#fefae0]/50 p-10 rounded-[3.5rem] border-4 border-dashed border-[#ffcdb2] space-y-8 shadow-inner">
                                                    <h3 className="text-[#b5838d] text-xl font-bold tracking-widest flex items-center gap-3">ğŸ“ èº«é«”æ•¸æ“šæ¸¬é‡</h3>
                                                    <div className="grid grid-cols-2 gap-6">
                                                        <div className="bg-white p-5 rounded-3xl text-center shadow-sm"><label className="text-xs text-[#b5838d] block mb-2 font-bold">æ”¶ç¸®å£“</label><input type="number" value={formData.systolic} onChange={e => setFormData({...formData, systolic: e.target.value})} className="w-full outline-none text-3xl text-center text-[#6d597a] font-bold" /></div>
                                                        <div className="bg-white p-5 rounded-3xl text-center shadow-sm"><label className="text-xs text-[#b5838d] block mb-2 font-bold">èˆ’å¼µå£“</label><input type="number" value={formData.diastolic} onChange={e => setFormData({...formData, diastolic: e.target.value})} className="w-full outline-none text-3xl text-center text-[#6d597a] font-bold" /></div>
                                                        <div className="bg-white p-5 rounded-3xl text-center shadow-sm"><label className="text-xs text-[#b5838d] block mb-2 font-bold">å¿ƒè·³</label><input type="number" value={formData.heartRate} onChange={e => setFormData({...formData, heartRate: e.target.value})} className="w-full outline-none text-3xl text-center text-[#6d597a] font-bold" /></div>
                                                        <div className="bg-white p-5 rounded-3xl text-center shadow-sm"><label className="text-xs text-[#b5838d] block mb-2 font-bold">é«”é‡</label><input type="number" step="0.1" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} className="w-full outline-none text-3xl text-center text-[#6d597a] font-bold" /></div>
                                                    </div>
                                                </div>

                                                <div className="bg-[#ffcdb2]/20 p-10 rounded-[3.5rem] border-4 border-dashed border-white space-y-6">
                                                    <h3 className="text-[#6d597a] text-xl font-bold tracking-widest flex items-center gap-3">ğŸ’Š æœç”¨è—¥å“ç´€éŒ„</h3>
                                                    <input type="text" value={formData.medication} onChange={e => setFormData({...formData, medication: e.target.value})} className="w-full px-8 py-5 bg-white rounded-3xl outline-none text-2xl shadow-sm border-2 border-transparent focus:border-[#ffcdb2] transition-all" placeholder="è—¥å“åç¨±" />
                                                    <input type="text" value={formData.frequency} onChange={e => setFormData({...formData, frequency: e.target.value})} className="w-full px-8 py-5 bg-white rounded-3xl outline-none text-2xl shadow-sm border-2 border-transparent focus:border-[#ffcdb2] transition-all" placeholder="æœç”¨é »ç‡" />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-8 pt-10 font-bold">
                                            {editingRecord && <button type="button" onClick={() => { if(confirm('ç¢ºå®šè¦æ¯€æ»…é€™ç­†ç´€éŒ„å—ï¼Ÿ')) window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', editingRecord.id)); setIsModalOpen(false); }} className="p-8 bg-white border-4 border-[#ffcdb2] text-[#ffcdb2] rounded-[3rem] hover:bg-red-50 hover:text-red-400 active:scale-90 transition-all"><Icon name="Trash2" size={40} /></button>}
                                            <button 
                                                type="submit" 
                                                disabled={isSaving}
                                                className={`flex-1 py-8 text-white text-3xl rounded-[3rem] shadow-2xl transition-all active:scale-95 outline-none font-bold ${isSaving ? 'bg-gray-300' : 'bg-[#ffb4a2] hover:bg-[#e5989b]'}`}
                                            >
                                                {isSaving ? "æ­£åœ¨è“‹ç« ä¸­..." : "è“‹ç« å„²å­˜ç­†è¨˜ ğŸ¾"}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>