<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨å®¶èº«é«”ç´€éŒ„ 2026</title>
    
    <!-- PWA æ¡Œé¢åŒ–é—œéµæ¨™ç±¤ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶æ—å¥åº·">
    <meta name="theme-color" content="#f5f2e9">
    
    <!-- åŸºç¤å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- åœ–è¡¨èˆ‡åœ–ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- å·¥å…·åº« -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥åœ“æ½¤å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400&family=Noto+Sans+TC:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-earth: #f5f2e9;
            --accent-brown: #a98467;
            --border-cream: #faedcd;
        }

        /* çµ•å°å¼·åˆ¶ï¼šå…¨åŸŸå­—é«”ä¸€è‡´ã€çµ•ç„¡ç²—é«”ã€æ–‡å­—å…¨é¢æ”¾å¤§ */
        * {
            font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif !important;
            font-weight: 400 !important;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-earth);
            color: #6b705c;
            margin: 0;
            padding: 0;
            font-size: 20px; 
            overscroll-behavior-y: contain;
        }

        h1, h2, h3, h4, b, strong, button, span, div, p, input, textarea, select {
            font-weight: 400 !important;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-earth); }
        ::-webkit-scrollbar-thumb { background: var(--border-cream); border-radius: 10px; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .animate-bounce-slow { animation: bounce-slow 4s infinite ease-in-out; }
        
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 30s linear infinite; }

        .recharts-cartesian-axis-tick-value { font-size: 14px !important; fill: #a98467; }
        .recharts-tooltip-label, .recharts-tooltip-item-name, .recharts-tooltip-item-value { font-size: 16px !important; }
        
        .med-card { word-wrap: break-word; overflow-wrap: break-word; line-height: 1.6; }

        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FirebaseSDK = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, deleteDoc, query };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment, useRef } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = window.Recharts;

        // é è¨­æˆå“¡åŸºç¤è³‡æ–™
        const DEFAULT_MEMBERS = [
            { id: 'dad', name: 'çˆ¸çˆ¸', defaultColor: '#bae6fd' },
            { id: 'mom', name: 'åª½åª½', defaultColor: '#fbcfe8' }
        ];

        const Icon = ({ name, size = 32, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    i.setAttribute('data-lucide', kebabName);
                    containerRef.current.appendChild(i);
                    window.lucide.createIcons({
                        elements: [i],
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        const firebaseConfig = {
            apiKey: "AIzaSyCMo1zj-zXLtwGd1WFtISt_O6ku8pmZOMc",
            authDomain: "health-86609.firebaseapp.com",
            projectId: "health-86609",
            storageBucket: "health-86609.firebasestorage.app",
            messagingSenderId: "969606507760",
            appId: "1:969606507760:web:2223db1994907d1c97a635",
            measurementId: "G-Q1VYJQVRBF"
        };

        const MONTH_NAMES = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
        const WEEKDAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [records, setRecords] = useState([]);
            // ç”¨æ–¼å„²å­˜çˆ¸çˆ¸åª½åª½é¡è‰²çš„ State
            const [memberColors, setMemberColors] = useState({ dad: '#bae6fd', mom: '#fbcfe8' });
            
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [isInstallModalOpen, setIsInstallModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [editingRecord, setEditingRecord] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            const [formData, setFormData] = useState({ memberId: 'dad', hospital: '', department: '', problem: '', systolic: '', diastolic: '', heartRate: '', weight: '', medication: '', frequency: '' });

            const appId = 'health-diary-family-2026-v3';

            useEffect(() => {
                const initFirebase = () => {
                    if (window.FirebaseSDK) {
                        const app = window.FirebaseSDK.initializeApp(firebaseConfig);
                        const firestore = window.FirebaseSDK.getFirestore(app);
                        const fireauth = window.FirebaseSDK.getAuth(app);
                        setDb(firestore);
                        setAuth(fireauth);

                        window.FirebaseSDK.onAuthStateChanged(fireauth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                    }
                };
                initFirebase();
            }, []);

            // åŒæ­¥ç´€éŒ„èˆ‡é¡è‰²è¨­å®š
            useEffect(() => {
                if (!user || !db) return;
                
                // 1. åŒæ­¥å¥åº·ç´€éŒ„
                const qRecords = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
                const unsubRecords = window.FirebaseSDK.onSnapshot(qRecords, (snapshot) => {
                    setRecords(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                // 2. åŒæ­¥æˆå“¡é¡è‰²è¨­å®š
                const colorDocRef = window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'memberColors');
                const unsubColors = window.FirebaseSDK.onSnapshot(colorDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setMemberColors(docSnap.data());
                    }
                });

                return () => { unsubRecords(); unsubColors(); };
            }, [user, db]);

            // è¨ˆç®—æœ€çµ‚æˆå“¡æ¸…å–® (çµåˆå›ºå®šåå–®èˆ‡è‡ªè¨‚é¡è‰²)
            const members = useMemo(() => {
                return DEFAULT_MEMBERS.map(m => ({
                    ...m,
                    color: memberColors[m.id] || m.defaultColor
                }));
            }, [memberColors]);

            const login = async () => {
                const provider = new window.FirebaseSDK.GoogleAuthProvider();
                try { await window.FirebaseSDK.signInWithPopup(auth, provider); } catch (err) { alert(err.message); }
            };

            const updateColor = async (id, newColor) => {
                if (!db || !user) return;
                const newSettings = { ...memberColors, [id]: newColor };
                const colorDocRef = window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'memberColors');
                await window.FirebaseSDK.setDoc(colorDocRef, newSettings);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSaving) return;

                setIsSaving(true);
                try {
                    const path = window.FirebaseSDK.collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
                    const data = { ...formData, date: selectedDate, updatedAt: new Date().toISOString() };
                    
                    if (editingRecord) {
                        await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', editingRecord.id), data);
                    } else {
                        await window.FirebaseSDK.addDoc(path, data);
                    }
                    
                    setIsModalOpen(false);
                } catch (error) {
                    console.error("Save failed:", error);
                    alert("å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯ Firebase Rules æ¬Šé™æœªé–‹å•Ÿæˆ–ç¶²è·¯å•é¡Œã€‚\néŒ¯èª¤è¨Šæ¯ï¼š" + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const exportToCSV = () => {
                if (records.length === 0) { alert("ç›®å‰æ²’æœ‰ç´€éŒ„å¯ä»¥åŒ¯å‡ºå–”ï¼"); return; }
                const headers = ["æ—¥æœŸ", "æˆå“¡", "é†«é™¢", "ç§‘åˆ¥", "ç—…ç—‡æè¿°", "æ”¶ç¸®å£“", "èˆ’å¼µå£“", "å¿ƒè·³", "é«”é‡", "è—¥å“", "é »ç‡"];
                const csvRows = [headers, ...records.map(r => {
                    const mName = members.find(m => m.id === r.memberId)?.name || "æœªçŸ¥";
                    return [
                        r.date, mName, r.hospital || "", r.department || "", 
                        (r.problem || "").replace(/\n/g, " "), r.systolic || "", r.diastolic || "", 
                        r.heartRate || "", r.weight || "", r.medication || "", r.frequency || ""
                    ];
                })];
                const csvContent = "\ufeff" + csvRows.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `å®¶æ—å¥åº·ç´€éŒ„_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = new Date(year, month, 1).getDay();

            const chartData = useMemo(() => {
                return Array.from({ length: daysInMonth }, (_, i) => {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i + 1).padStart(2, '0')}`;
                    const dayObj = { displayDate: `${month + 1}/${i + 1}` };
                    records.filter(r => r.date === dateStr).forEach(r => {
                        const mid = r.memberId;
                        if (r.systolic) dayObj[`${mid}_systolic`] = parseFloat(r.systolic);
                        if (r.diastolic) dayObj[`${mid}_diastolic`] = parseFloat(r.diastolic);
                        if (r.heartRate) dayObj[`${mid}_heartRate`] = parseFloat(r.heartRate);
                        if (r.weight) dayObj[`${mid}_weight`] = parseFloat(r.weight);
                    });
                    return dayObj;
                });
            }, [records, month, year, daysInMonth]);

            if (loading) return null;

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-8 bg-[#f5f2e9]">
                        <div className="bg-white rounded-[3rem] border-4 border-dashed border-[#faedcd] p-10 text-center max-w-xl w-full shadow-2xl">
                            <Icon name="Heart" size={80} className="text-pink-300 mx-auto mb-6 animate-bounce-slow" />
                            <h1 className="text-4xl text-[#a98467] mb-4 font-normal">å…¨å®¶èº«é«”ç´€éŒ„ 2026</h1>
                            <p className="text-slate-400 mb-10 text-xl font-normal">ç™»å…¥ Google å¸³è™Ÿé–‹å•Ÿç§æœ‰åŒæ­¥ç©ºé–“ ğŸŒ³</p>
                            <button onClick={login} className="w-full py-6 bg-white border-2 border-[#faedcd] text-[#a98467] rounded-full text-2xl hover:bg-[#fefae0] transition-all flex items-center justify-center gap-4 shadow-xl active:scale-95">
                                <Icon name="LogIn" size={36} /> Google å¸³è™Ÿç™»å…¥
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24">
                    {/* é ‚éƒ¨å°èˆª */}
                    <header className="sticky top-0 z-30 px-6 py-4 bg-white/70 backdrop-blur-md border-b-2 border-dashed border-[#e9edc9] flex items-center justify-between">
                        <div className="flex items-center gap-2 sm:gap-4">
                            <button onClick={() => setIsSettingsModalOpen(true)} className="flex items-center gap-2 text-[#a98467] hover:scale-105 transition-transform">
                                <Icon name="Palette" size={28} />
                                <span className="text-lg hidden sm:inline underline decoration-dotted">æˆå“¡è¨­å®š</span>
                            </button>
                            <button onClick={exportToCSV} className="flex items-center gap-2 text-[#a98467] hover:scale-105 transition-transform">
                                <Icon name="FileDown" size={28} />
                                <span className="text-lg hidden sm:inline underline decoration-dotted">åŒ¯å‡º</span>
                            </button>
                            <button onClick={() => setIsInstallModalOpen(true)} className="flex items-center gap-2 text-indigo-400 hover:scale-105 transition-transform">
                                <Icon name="Download" size={28} />
                                <span className="text-lg hidden sm:inline underline decoration-dotted">å®‰è£</span>
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-3 sm:gap-6 bg-[#fefae0] rounded-full px-4 py-2 border border-[#faedcd] shadow-sm">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="text-[#d4a373]"><Icon name="ChevronLeft" size={28} /></button>
                            <span className="text-xl sm:text-2xl min-w-[110px] text-center font-normal">{year} / {MONTH_NAMES[month]}</span>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="text-[#d4a373]"><Icon name="ChevronRight" size={28} /></button>
                        </div>

                        <button onClick={() => window.FirebaseSDK.signOut(auth)} className="p-2 text-[#a98467] opacity-60"><Icon name="LogOut" size={28} /></button>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 sm:p-6 space-y-10">
                        
                        {/* è—¥ç®±æ‘˜è¦ */}
                        <section className="bg-white rounded-[3rem] p-8 shadow-sm border-2 border-dashed border-[#faedcd] relative">
                            <div className="absolute -top-6 left-8 bg-[#f5f2e9] px-6 py-1 flex items-center gap-3 text-[#a98467] z-10 font-normal"><Icon name="Pill" size={32} /><h2 className="text-2xl">æˆå“¡è—¥ç®± ğŸ’Š</h2></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4">
                                {members.map(m => {
                                    const medRecords = records.filter(r => r.memberId === m.id && r.medication);
                                    return (
                                        <div key={m.id} className="rounded-[2.5rem] p-6 border-2 border-white shadow-sm relative med-card" style={{ backgroundColor: `${m.color}20`, borderColor: `${m.color}40` }}>
                                            <div className="flex items-center gap-3 mb-4 text-xl" style={{ color: m.color }}>
                                                <div className="w-5 h-5 rounded-full border-2 border-white shadow-inner" style={{ backgroundColor: m.color }}></div>
                                                <span className="font-normal">{m.name}</span>
                                            </div>
                                            <div className="space-y-3">
                                                {medRecords.length > 0 ? medRecords.slice(0, 3).map((med, idx) => (
                                                    <div key={idx} className="bg-white/80 p-4 rounded-2xl shadow-sm border border-white/50">
                                                        <div className="text-slate-700 border-b border-gray-100 pb-1 mb-1 text-lg font-normal">{med.medication}</div>
                                                        <div className="text-slate-400 text-sm italic font-normal">é »ç‡ï¼š{med.frequency || '--'}</div>
                                                    </div>
                                                )) : <p className="text-sm opacity-30 italic text-center py-4 font-normal">å°šç„¡è—¥ç‰©ç´€éŒ„</p>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* æœˆæ›† */}
                        <section className="bg-white rounded-[3rem] shadow-xl border-4 border-white outline outline-1 outline-[#faedcd] overflow-hidden font-normal">
                            <div className="grid grid-cols-7 bg-[#fefae0]/40 border-b-2 border-dashed border-[#faedcd] text-[#d4a373]">
                                {WEEKDAYS.map(day => <div key={day} className="py-4 text-center text-sm">{day}</div>)}
                            </div>
                            <div className="grid grid-cols-7">
                                {[...Array(startingDay)].map((_, i) => <div key={`e-${i}`} className="min-h-[100px] bg-[#f5f2e9]/20 border-b border-r border-[#faedcd]/20" />)}
                                {[...Array(daysInMonth)].map((_, i) => {
                                    const d = i + 1;
                                    const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const dayRecs = records.filter(r => r.date === dStr);
                                    const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
                                    return (
                                        <div key={d} onClick={() => { setSelectedDate(dStr); setEditingRecord(null); setFormData(prev => ({ ...prev, hospital: '', department: '', problem: '', medication: '', frequency: '', systolic: '', diastolic: '', heartRate: '', weight: '' })); setIsModalOpen(true); }} 
                                            className="min-h-[100px] border-b border-r border-[#faedcd]/10 p-2 hover:bg-[#e9edc9]/20 transition-all cursor-pointer">
                                            <div className={`text-base w-9 h-9 flex items-center justify-center rounded-full mb-1 ${isToday ? 'bg-[#d4a373] text-white shadow-lg' : 'text-[#ccd5ae]'}`}>{d}</div>
                                            <div className="flex flex-col gap-1">
                                                {dayRecs.map(rec => {
                                                    const m = members.find(mem => mem.id === rec.memberId);
                                                    return (
                                                        <div key={rec.id} onClick={(e) => { e.stopPropagation(); setSelectedDate(rec.date); setEditingRecord(rec); setFormData(rec); setIsModalOpen(true); }} 
                                                            className="text-[10px] px-1.5 py-1 rounded-lg text-white truncate shadow-sm font-normal" 
                                                            style={{ backgroundColor: m?.color || '#a98467' }}>
                                                            {rec.department || rec.hospital || 'â—'}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* åœ–è¡¨åˆ†æ */}
                        <section className="space-y-8">
                            <div className="flex items-center gap-4 px-4 text-[#a98467] font-normal"><Icon name="Activity" /><h2 className="text-2xl italic">å®¶æ—å¥åº·åˆ†æ</h2><div className="flex-1 border-b-2 border-dotted border-[#faedcd]"></div></div>
                            
                            <div className="bg-white p-6 sm:p-10 rounded-[3rem] shadow-sm border border-[#faedcd] h-[400px]">
                                <h3 className="text-xl mb-4 text-[#a98467] font-normal">è¡€å£“ç´€éŒ„ (å¯¦ç·š:æ”¶ç¸® / è™›ç·š:èˆ’å¼µ)</h3>
                                <ResponsiveContainer width="100%" height="90%">
                                    <LineChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#faedcd" />
                                        <XAxis dataKey="displayDate" style={{fontSize: '12px'}} />
                                        <YAxis width={40} domain={['dataMin - 5', 'dataMax + 5']} style={{fontSize: '12px'}} />
                                        <Tooltip contentStyle={{ borderRadius: '20px', border: '1px solid #faedcd', backgroundColor: '#fff', fontSize: '14px' }} />
                                        {members.map(m => (
                                            <Fragment key={m.id}>
                                                <Line type="monotone" dataKey={`${m.id}_systolic`} stroke={m.color} strokeWidth={4} dot={{ r: 4 }} connectNulls />
                                                <Line type="monotone" dataKey={`${m.id}_diastolic`} stroke={m.color} strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3 }} connectNulls />
                                            </Fragment>
                                        ))}
                                        <ReferenceLine y={140} stroke="#d4a373" strokeDasharray="3 3" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="bg-white p-6 sm:p-8 rounded-[3rem] shadow-sm border border-[#faedcd] h-[350px]">
                                    <h3 className="text-lg mb-4 text-[#a98467] font-normal">å¿ƒè·³èµ°å‹¢ (bpm)</h3>
                                    <ResponsiveContainer width="100%" height="85%">
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#faedcd" />
                                            <XAxis dataKey="displayDate" style={{fontSize: '10px'}} />
                                            <YAxis width={35} domain={[40, 120]} style={{fontSize: '10px'}} />
                                            <Tooltip contentStyle={{ borderRadius: '15px', border: '1px solid #faedcd', fontSize: '12px' }} />
                                            {members.map(m => (<Line key={m.id} type="monotone" dataKey={`${m.id}_heartRate`} stroke={m.color} strokeWidth={4} dot={{ r: 4 }} connectNulls />))}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-white p-6 sm:p-8 rounded-[3rem] shadow-sm border border-[#faedcd] h-[350px]">
                                    <h3 className="text-lg mb-4 text-[#a98467] font-normal">é«”é‡è®Šå‹• (kg)</h3>
                                    <ResponsiveContainer width="100%" height="85%">
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#faedcd" />
                                            <XAxis dataKey="displayDate" style={{fontSize: '10px'}} />
                                            <YAxis width={35} domain={['auto', 'auto']} style={{fontSize: '10px'}} />
                                            <Tooltip contentStyle={{ borderRadius: '15px', border: '1px solid #faedcd', fontSize: '12px' }} />
                                            {members.map(m => (<Line key={m.id} type="monotone" dataKey={`${m.id}_weight`} stroke={m.color} strokeWidth={4} dot={{ r: 4 }} connectNulls />))}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </section>
                    </main>

                    {/* æˆå“¡é¡è‰²è¨­å®š Modal */}
                    {isSettingsModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/40 backdrop-blur-md">
                            <div className="bg-white rounded-[3rem] w-full max-w-md p-8 shadow-2xl modal-fade-in border-4 border-white outline outline-1 outline-[#faedcd]">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl text-[#a98467] font-normal">æˆå“¡é¡è‰²è¨­å®š</h2>
                                    <button onClick={() => setIsSettingsModalOpen(false)} className="p-2 bg-[#f5f2e9] rounded-full"><Icon name="X" /></button>
                                </div>
                                
                                <div className="space-y-8 font-normal">
                                    {members.map(m => (
                                        <div key={m.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 rounded-full shadow-sm" style={{ backgroundColor: m.color }}></div>
                                                <span className="text-xl">{m.name}</span>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <label className="text-sm text-slate-400 italic">é¸é¡è‰²</label>
                                                <input type="color" value={m.color} onChange={e => updateColor(m.id, e.target.value)} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <p className="mt-8 text-center text-slate-400 text-sm font-normal">ä¿®æ”¹å¾Œæœˆæ›†èˆ‡åœ–è¡¨æœƒåŒæ­¥æ›´æ›é¡è‰² ğŸ¨</p>
                            </div>
                        </div>
                    )}

                    {/* å®‰è£æŒ‡å— Modal */}
                    {isInstallModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/40 backdrop-blur-md">
                            <div className="bg-white rounded-[3rem] w-full max-w-md p-8 shadow-2xl modal-fade-in border-4 border-white outline outline-1 outline-[#faedcd]">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl text-[#a98467] font-normal">å®‰è£è‡³æ‰‹æ©Ÿæ¡Œé¢</h2>
                                    <button onClick={() => setIsInstallModalOpen(false)} className="p-2 bg-[#f5f2e9] rounded-full"><Icon name="X" /></button>
                                </div>
                                <div className="space-y-8 text-lg text-slate-600 font-normal">
                                    <div className="space-y-3">
                                        <p className="font-bold text-[#a98467] border-b border-dashed border-[#faedcd] pb-1">iPhone (Safari)</p>
                                        <ol className="list-decimal list-inside space-y-1">
                                            <li>é»æ“Š Safari ä¸‹æ–¹çš„ <Icon name="Share" size={20} className="inline mx-1 text-blue-500" /> åˆ†äº«åœ–ç¤º</li>
                                            <li>é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li>
                                            <li>é»æ“Šå³ä¸Šè§’ã€Œæ–°å¢ã€</li>
                                        </ol>
                                    </div>
                                    <div className="space-y-3">
                                        <p className="font-bold text-[#a98467] border-b border-dashed border-[#faedcd] pb-1">Android (Chrome)</p>
                                        <ol className="list-decimal list-inside space-y-1">
                                            <li>é»æ“Š Chrome å³ä¸Šè§’çš„ã€Œä¸‰å€‹é»ã€é¸å–®</li>
                                            <li>é»æ“Šã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€Œæ–°å¢è‡³æ¡Œé¢ã€</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ•¸æ“šç´€éŒ„ Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#6b705c]/40 backdrop-blur-md">
                            <div className="bg-white rounded-[4rem] w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl border-4 border-white outline outline-4 outline-[#faedcd] modal-fade-in">
                                <div className="p-8 sm:p-12 font-normal">
                                    <div className="flex justify-between items-center mb-10">
                                        <div><h2 className="text-3xl text-[#a98467]">èº«é«”å°ç­†è¨˜ ğŸŒ³</h2><p className="text-[#d4a373] text-xl underline decoration-dotted mt-1">{selectedDate}</p></div>
                                        <button onClick={() => setIsModalOpen(false)} className="p-4 bg-[#f5f2e9] text-[#ccd5ae] rounded-full hover:rotate-90 transition-all"><Icon name="X" size={40} /></button>
                                    </div>
                                    
                                    <form onSubmit={handleSubmit} className="space-y-12">
                                        {/* æˆå“¡é¸æ“‡ */}
                                        <div className="flex flex-wrap gap-4">
                                            {members.map(m => (
                                                <button key={m.id} type="button" onClick={() => setFormData({...formData, memberId: m.id})} 
                                                    className={`px-8 py-4 rounded-2xl border-2 text-2xl transition-all active:scale-95 ${formData.memberId === m.id ? 'border-[#a98467] shadow-lg scale-105 font-normal' : 'bg-gray-50 text-gray-300 border-transparent font-normal'}`}
                                                    style={formData.memberId === m.id ? { color: m.color, backgroundColor: `${m.color}20`, borderColor: m.color } : {}}>
                                                    {m.name}
                                                </button>
                                            ))}
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 font-normal">
                                            <div className="space-y-8">
                                                <label className="block text-[#ccd5ae] italic text-lg">å°±è¨ºç‹€æ³æè¿°</label>
                                                <input type="text" value={formData.hospital} onChange={e => setFormData({...formData, hospital: e.target.value})} className="w-full px-6 py-5 bg-[#f5f2e9] rounded-[2rem] outline-none text-xl font-normal" placeholder="é†«é™¢åç¨±" />
                                                <input type="text" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} className="w-full px-6 py-5 bg-[#f5f2e9] rounded-[2rem] outline-none text-xl font-normal" placeholder="å°±è¨ºç§‘åˆ¥" />
                                                <textarea value={formData.problem} onChange={e => setFormData({...formData, problem: e.target.value})} className="w-full px-6 py-5 bg-[#f5f2e9] rounded-[2rem] outline-none h-40 text-xl font-normal" placeholder="èº«é«”ç‹€æ³æè¿°..."></textarea>
                                            </div>
                                            
                                            <div className="space-y-10">
                                                <div className="bg-[#fefae0] p-8 rounded-[3rem] border-2 border-dashed border-[#faedcd] space-y-6 shadow-sm font-normal">
                                                    <h3 className="text-[#d4a373] text-lg tracking-widest uppercase flex items-center gap-3">èº«é«”æ•¸æ“šæ¸¬é‡</h3>
                                                    <div className="grid grid-cols-2 gap-5">
                                                        <div className="bg-white p-4 rounded-2xl text-center shadow-sm"><label className="text-xs text-[#ccd5ae] block mb-1">æ”¶ç¸®å£“</label><input type="number" value={formData.systolic} onChange={e => setFormData({...formData, systolic: e.target.value})} className="w-full outline-none text-2xl text-center text-[#a98467] font-normal" /></div>
                                                        <div className="bg-white p-4 rounded-2xl text-center shadow-sm"><label className="text-xs text-[#ccd5ae] block mb-1">èˆ’å¼µå£“</label><input type="number" value={formData.diastolic} onChange={e => setFormData({...formData, diastolic: e.target.value})} className="w-full outline-none text-2xl text-center text-[#a98467] font-normal" /></div>
                                                        <div className="bg-white p-4 rounded-2xl text-center shadow-sm"><label className="text-xs text-[#ccd5ae] block mb-1">å¿ƒè·³</label><input type="number" value={formData.heartRate} onChange={e => setFormData({...formData, heartRate: e.target.value})} className="w-full outline-none text-2xl text-center text-[#a98467] font-normal" /></div>
                                                        <div className="bg-white p-4 rounded-2xl text-center shadow-sm"><label className="text-xs text-[#ccd5ae] block mb-1">é«”é‡</label><input type="number" step="0.1" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} className="w-full outline-none text-2xl text-center text-[#a98467] font-normal" /></div>
                                                    </div>
                                                </div>

                                                <div className="bg-[#e9edc9]/40 p-8 rounded-[3rem] border-2 border-dashed border-[#ccd5ae] space-y-5 font-normal">
                                                    <h3 className="text-[#6b705c] text-lg tracking-widest uppercase flex items-center gap-3">æœç”¨è—¥ç‰©ç´€éŒ„</h3>
                                                    <input type="text" value={formData.medication} onChange={e => setFormData({...formData, medication: e.target.value})} className="w-full px-6 py-4 bg-white rounded-2xl outline-none text-xl shadow-sm font-normal" placeholder="è—¥å“åç¨±" />
                                                    <input type="text" value={formData.frequency} onChange={e => setFormData({...formData, frequency: e.target.value})} className="w-full px-6 py-4 bg-white rounded-2xl outline-none text-xl shadow-sm font-normal" placeholder="æœç”¨é »ç‡" />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-6 pt-10 font-normal">
                                            {editingRecord && <button type="button" onClick={() => { if(confirm('ç¢ºå®šåˆªé™¤ç´€éŒ„å—ï¼Ÿ')) window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', editingRecord.id)); setIsModalOpen(false); }} className="p-6 bg-gray-50 text-gray-300 rounded-[2.5rem] hover:text-red-400 active:bg-red-50 transition-all"><Icon name="Trash2" size={32} /></button>}
                                            <button 
                                                type="submit" 
                                                disabled={isSaving}
                                                className={`flex-1 py-6 text-white text-2xl rounded-[2.5rem] shadow-2xl transition-all active:scale-95 outline-none font-normal ${isSaving ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#d4a373] hover:bg-[#a98467]'}`}
                                            >
                                                {isSaving ? "æ­£åœ¨å„²å­˜..." : "å„²å­˜ç´€éŒ„ ğŸ‚"}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>