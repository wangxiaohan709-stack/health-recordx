import React, { useState, useEffect, useMemo, Fragment, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, query } from 'firebase/firestore';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine
} from 'recharts';
import { 
  ChevronLeft, ChevronRight, Heart, Pill, Trash2, X, Activity, Scale, Sun, Star, FileDown, LogIn, LogOut, AlertCircle
} from 'lucide-react';

/**
 * ==========================================
 * ã€é‡è¦ï¼šFirebase å¯†é‘°è¨­å®šå€ã€‘
 * è«‹å°‡æ‚¨åœ¨ Firebase Console å–å¾—çš„ config ç‰©ä»¶è²¼åœ¨ä¸‹æ–¹ null çš„ä½ç½®
 * ==========================================
 */
const myCustomFirebaseConfig = {
  apiKey: "AIzaSyCMo1zj-zXLtwGd1WFtISt_O6ku8pmZOMc",
  authDomain: "health-86609.firebaseapp.com",
  projectId: "health-86609",
  storageBucket: "health-86609.firebasestorage.app",
  messagingSenderId: "969606507760",
  appId: "1:969606507760:web:2223db1994907d1c97a635",
  measurementId: "G-Q1VYJQVRBF" }; 

// åˆå§‹åŒ– Firebase
const config = myCustomFirebaseConfig || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-health-2026-private';

let app, auth, db;
if (config) {
  app = initializeApp(config);
  auth = getAuth(app);
  db = getFirestore(app);
}

const MEMBERS = [
  { id: 'dad', name: 'çˆ¸çˆ¸', color: '#bae6fd', bgColor: 'bg-blue-100/70', border: 'border-blue-200', text: 'text-blue-500' },
  { id: 'mom', name: 'åª½åª½', color: '#fbcfe8', bgColor: 'bg-pink-100/70', border: 'border-pink-200', text: 'text-pink-500' },
  { id: 'me', name: 'æˆ‘', color: '#bbf7d0', bgColor: 'bg-green-100/70', border: 'border-green-200', text: 'text-green-500' },
];

const MONTH_NAMES = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
const WEEKDAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

export default function App() {
  const [user, setUser] = useState(null);
  const [records, setRecords] = useState([]);
  const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  const [editingRecord, setEditingRecord] = useState(null);
  const [loading, setLoading] = useState(true);
  const [authError, setAuthError] = useState(null);

  const [formData, setFormData] = useState({
    memberId: 'dad', hospital: '', department: '', problem: '',
    systolic: '', diastolic: '', heartRate: '', weight: '',
    medication: '', frequency: '', medDuration: ''
  });

  // 1. ç›£è½ç™»å…¥ç‹€æ…‹ (Rule 3)
  useEffect(() => {
    if (!auth) {
      setLoading(false);
      return;
    }
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. é›²ç«¯æ•¸æ“šåŒæ­¥ (ä¾æ“š User UID ç§æœ‰è·¯å¾‘ - Rule 1)
  useEffect(() => {
    if (!user || !db) return;
    
    // å°‡è³‡æ–™å­˜æ”¾åœ¨ users/{userId} ä¸‹ï¼Œç¢ºä¿å¸³è™Ÿä¹‹é–“äº’ä¸å¹²æ¶‰
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setRecords(data);
    }, (err) => {
      console.error("Firestore åŒæ­¥éŒ¯èª¤:", err);
    });
    
    return () => unsubscribe();
  }, [user]);

  const handleLogin = async () => {
    setAuthError(null);
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      if (err.code === 'auth/unauthorized-domain') {
        setAuthError(`ç›®å‰çš„ç¶²åŸŸ (${window.location.hostname}) å°šæœªè¢«æˆæ¬Šã€‚è«‹å‰å¾€ Firebase Console -> Authentication -> Settings åŠ å…¥æˆæ¬Šã€‚`);
      } else {
        setAuthError(err.message);
      }
    }
  };

  const handleLogout = () => signOut(auth);

  const month = currentDate.getMonth();
  const year = currentDate.getFullYear();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const startingDay = new Date(year, month, 1).getDay();

  const medicationsList = useMemo(() => {
    const meds = { dad: [], mom: [], me: [] };
    const sorted = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
    sorted.forEach(rec => {
      if (rec.medication && rec.memberId) {
        if (!meds[rec.memberId].some(m => m.name === rec.medication)) {
          meds[rec.memberId].push({ name: rec.medication, frequency: rec.frequency, duration: rec.medDuration });
        }
      }
    });
    return meds;
  }, [records]);

  const chartData = useMemo(() => {
    const dataMap = {};
    for (let i = 1; i <= daysInMonth; i++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
      dataMap[dateStr] = { displayDate: `${month + 1}/${i}` };
    }
    records.forEach(rec => {
      if (rec.date && dataMap[rec.date]) {
        const mid = rec.memberId;
        if (rec.systolic) dataMap[rec.date][`${mid}_systolic`] = parseFloat(rec.systolic);
        if (rec.diastolic) dataMap[rec.date][`${mid}_diastolic`] = parseFloat(rec.diastolic);
        if (rec.heartRate) dataMap[rec.date][`${mid}_heartRate`] = parseFloat(rec.heartRate);
        if (rec.weight) dataMap[rec.date][`${mid}_weight`] = parseFloat(rec.weight);
      }
    });
    return Object.values(dataMap);
  }, [records, month, year, daysInMonth]);

  const openAddModal = (dateStr) => {
    setSelectedDate(dateStr);
    setEditingRecord(null);
    setFormData({ memberId: 'dad', hospital: '', department: '', problem: '', systolic: '', diastolic: '', heartRate: '', weight: '', medication: '', frequency: '', medDuration: '' });
    setIsModalOpen(true);
  };

  const openEditModal = (record) => {
    setSelectedDate(record.date);
    setEditingRecord(record);
    setFormData({ ...record });
    setIsModalOpen(true);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user || !db) return;
    
    // ç§æœ‰è·¯å¾‘ï¼šåƒ…é™æœ¬äººå­˜å–
    const path = collection(db, 'artifacts', appId, 'users', user.uid, 'health_records');
    const dataToSave = { 
      ...formData, 
      date: selectedDate, 
      updatedAt: new Date().toISOString()
    };

    try {
      if (editingRecord) {
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', editingRecord.id), dataToSave);
      } else {
        await addDoc(path, dataToSave);
      }
      setIsModalOpen(false);
    } catch (err) { console.error("å„²å­˜ç´€éŒ„å¤±æ•—:", err); }
  };

  const handleDelete = async (id) => {
    if (!window.confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'health_records', id));
      setIsModalOpen(false);
    } catch (err) { console.error("åˆªé™¤ç´€éŒ„å¤±æ•—:", err); }
  };

  const exportToCSV = () => {
    if (records.length === 0) return;
    const sorted = [...records].sort((a, b) => a.date.localeCompare(b.date));
    const headers = ["æ—¥æœŸ", "æˆå“¡", "é†«é™¢", "ç§‘åˆ¥", "æè¿°", "æ”¶ç¸®å£“", "èˆ’å¼µå£“", "å¿ƒè·³", "é«”é‡", "è—¥å", "é »ç‡", "æœŸé™"];
    const csvRows = [headers];
    sorted.forEach(r => {
      const mName = MEMBERS.find(m => m.id === r.memberId)?.name || "";
      csvRows.push([r.date, mName, r.hospital||"", r.department||"", (r.problem||"").replace(/\n/g," "), r.systolic||"", r.diastolic||"", r.heartRate||"", r.weight||"", r.medication||"", r.frequency||"", r.medDuration||""]);
    });
    const blob = new Blob(["\ufeff" + csvRows.map(row => row.map(v => `"${v}"`).join(",")).join("\n")], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `å€‹äººå¥åº·å ±è¡¨_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
    link.click();
  };

  if (loading) return null;

  // ç™»å…¥ä»‹é¢ (å¦‚æœæœªç™»å…¥)
  if (!user) {
    return (
      <div className="min-h-screen bg-[#f5f2e9] flex items-center justify-center p-8 cute-font">
        <div className="bg-white rounded-[4rem] border-4 border-dashed border-[#faedcd] p-12 text-center max-w-2xl w-full shadow-2xl">
          <Heart size={80} className="text-pink-300 mx-auto mb-6 animate-bounce-slow" />
          <h1 className="text-4xl text-[#a98467] mb-4">å…¨å®¶èº«é«”ç´€éŒ„ 2026</h1>
          <p className="text-slate-400 mb-10 text-xl leading-relaxed font-normal">
            ç™»å…¥ Google é›²ç«¯å¸³è™Ÿ<br/>é–‹å•Ÿå€‹äººç§æœ‰çš„å¥åº·æ•¸æ“šç©ºé–“ ğŸŒ³
          </p>
          
          {authError && (
            <div className="bg-red-50 border-2 border-red-200 rounded-3xl p-6 mb-8 text-left text-red-600 text-sm font-normal">
              <div className="flex items-center gap-2 mb-2 font-normal text-lg"><AlertCircle size={24}/> ç¶²åŸŸæˆæ¬ŠéŒ¯èª¤</div>
              <p>{authError}</p>
            </div>
          )}

          {!config && (
            <div className="bg-orange-50 border-2 border-orange-200 rounded-3xl p-6 mb-8 text-left text-orange-600 text-sm italic font-normal">
              æç¤ºï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­çš„ myCustomFirebaseConfig å¡«å…¥å¯†é‘°ã€‚
            </div>
          )}

          <button 
            onClick={handleLogin}
            disabled={!config}
            className={`w-full py-6 rounded-full text-2xl flex items-center justify-center gap-4 shadow-xl transition-all active:scale-95 ${!config ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-white border-4 border-[#faedcd] text-[#a98467] hover:bg-[#fefae0]'}`}
          >
            <LogIn size={32} />
            é€é Google å¸³è™Ÿç™»å…¥
          </button>
          <p className="mt-8 text-slate-300 text-base font-normal">å¸³è™Ÿä¹‹é–“è³‡æ–™å®Œå…¨ç¨ç«‹ï¼Œç¢ºä¿éš±ç§ ğŸ”’</p>
        </div>
      </div>
    );
  }

  // ä¸»æ‡‰ç”¨ä»‹é¢ (å·²ç™»å…¥)
  return (
    <div className="min-h-screen bg-[#f5f2e9] text-[#6b705c] pb-20 cute-font">
      <header className="sticky top-0 z-30 px-8 py-6 bg-white/70 backdrop-blur-md border-b-2 border-dashed border-[#e9edc9]">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Sun className="text-[#d4a373] animate-spin-slow" size={32} />
            <span className="text-xl text-[#a98467] hidden lg:block italic">Health Diary 2026</span>
          </div>
          <div className="flex items-center gap-6 bg-[#fefae0] rounded-full px-10 py-3 border border-[#faedcd] shadow-sm">
            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="text-[#d4a373] hover:scale-125 transition-all"><ChevronLeft size={36} /></button>
            <span className="text-3xl min-w-[200px] text-center underline decoration-[#faedcd] decoration-4 font-normal">{year} / {MONTH_NAMES[month]}</span>
            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="text-[#d4a373] hover:scale-125 transition-all"><ChevronRight size={36} /></button>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={exportToCSV} className="p-4 bg-white border-2 border-dashed border-[#faedcd] text-[#a98467] rounded-3xl hover:bg-[#fefae0] transition-all flex items-center gap-3 text-lg shadow-sm outline-none font-normal">
              <FileDown size={28} /> <span className="hidden sm:inline">åŒ¯å‡ºå ±è¡¨</span>
            </button>
            <button onClick={handleLogout} className="p-4 text-[#a98467] hover:scale-110" title="ç™»å‡ºç³»çµ±"><LogOut size={32} /></button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-8 space-y-12">
        {/* è—¥ç®±æ¸…å–® */}
        <section className="bg-white rounded-[4rem] p-10 shadow-sm border-2 border-dashed border-[#faedcd] relative">
          <div className="absolute -top-7 left-14 bg-[#f5f2e9] px-8 py-2 flex items-center gap-4 z-10 text-[#a98467]">
            <Pill size={40} />
            <h2 className="text-3xl tracking-tight font-normal">æ—¥å¸¸è—¥ç®±æ¸…å–® ğŸ’Š</h2>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-10 pt-10">
            {MEMBERS.map(m => (
              <div key={m.id} className={`${m.bgColor} rounded-[3.5rem] p-10 border-2 border-white shadow-sm relative med-card`}>
                <div className="flex items-center gap-5 mb-8 text-3xl font-normal">
                  <div className={`w-8 h-8 rounded-full ${m.text.replace('text', 'bg')} border-2 border-white`}></div>
                  <span className={m.text}>{m.name}</span>
                </div>
                <div className="space-y-6">
                  {medicationsList[m.id].length > 0 ? medicationsList[m.id].map((med, idx) => (
                    <div key={idx} className="bg-white/95 p-6 rounded-[2.5rem] border border-[#faedcd] shadow-sm space-y-4">
                      <div className="text-slate-700 border-b border-[#faedcd] pb-3 text-2xl leading-relaxed font-normal">{med.name}</div>
                      <div className="flex flex-col gap-3 text-slate-500 text-xl font-normal">
                        <div>é »ç‡ï¼š{med.frequency || 'æœªå¡«å¯«'}</div>
                        <div className="bg-[#fefae0] text-base px-6 py-2 rounded-full inline-block text-[#d4a373] self-start shadow-sm font-normal">
                          æœŸé™ï¼š{med.duration || 'é•·æœŸæœç”¨'}
                        </div>
                      </div>
                    </div>
                  )) : <p className="text-xl text-[#a98467] opacity-60 italic py-10 text-center font-normal">ç›®å‰ç„¡ç”¨è—¥ç´€éŒ„ ğŸƒ</p>}
                </div>
              </div>
            ))}
          </div>
        </section>

        {/* æ—¥æ›†å€ */}
        <section className="bg-white rounded-[5rem] shadow-xl border-4 border-white outline outline-1 outline-[#faedcd] overflow-hidden relative">
          <div className="grid grid-cols-7 bg-[#fefae0]/40 border-b-2 border-dashed border-[#faedcd]">
            {WEEKDAYS.map(day => <div key={day} className="py-7 text-center text-xl text-[#d4a373] tracking-[0.3em] font-normal">{day}</div>)}
          </div>
          <div className="grid grid-cols-7">
            {[...Array(startingDay)].map((_, i) => <div key={`e-${i}`} className="min-h-[160px] bg-[#f5f2e9]/20 border-b border-r border-[#faedcd]/20" />)}
            {[...Array(daysInMonth)].map((_, i) => {
              const d = i + 1;
              const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
              const dayRecs = records.filter(r => r.date === dStr);
              const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
              return (
                <div key={d} onClick={() => openAddModal(dStr)} className="min-h-[160px] border-b border-r border-[#faedcd]/20 p-5 hover:bg-[#e9edc9]/20 transition-all cursor-pointer group relative">
                  <div className={`text-lg w-14 h-14 flex items-center justify-center rounded-3xl mb-5 transition-all ${isToday ? 'bg-[#d4a373] text-white shadow-lg scale-110' : 'text-[#ccd5ae] group-hover:text-[#d4a373]'}`}>{d}</div>
                  <div className="flex flex-col gap-3">
                    {dayRecs.map(rec => {
                      const m = MEMBERS.find(mem => mem.id === rec.memberId);
                      return rec.department || rec.hospital ? (
                        <div key={rec.id} onClick={(e) => { e.stopPropagation(); openEditModal(rec); }} className={`w-full text-base p-3 rounded-3xl border-b-2 ${m.bgColor} ${m.text} border-white shadow-sm truncate transition-transform hover:scale-105 font-normal`}>
                          {rec.department || rec.hospital}
                        </div>
                      ) : (
                        <div key={rec.id} onClick={(e) => { e.stopPropagation(); openEditModal(rec); }} className={`w-7 h-7 rounded-full ${m.bgColor} shadow-sm border-2 border-white mt-1 animate-bounce-slow`} />
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </section>

        {/* åœ–è¡¨å€ */}
        <section className="space-y-12">
          <div className="flex items-center gap-6 px-10">
            <Star className="text-[#d4a373]" size={40} />
            <h2 className="text-3xl text-[#a98467] italic font-normal">å¥åº·è¶¨å‹¢æ‰‹å¸³</h2>
            <div className="flex-1 border-b-4 border-dotted border-[#faedcd]"></div>
          </div>
          
          <div className="flex flex-col gap-12">
            {/* ä¸Šæ’ï¼šè¡€å£“ç´€éŒ„è¶¨å‹¢ */}
            <div className="bg-white p-12 rounded-[5rem] shadow-sm border border-[#faedcd]/50 space-y-10 transition-all hover:shadow-2xl relative group overflow-hidden">
              <div className="flex items-center gap-6 border-b-2 border-dotted border-[#faedcd] pb-6 text-[#d4a373]">
                <Activity size={40} />
                <h3 className="text-2xl text-[#a98467] uppercase font-normal">è¡€å£“è¶¨å‹¢ (æ”¶ç¸®å£“å¯¦ç·š / èˆ’å¼µå£“è™›ç·š)</h3>
              </div>
              <div className="h-[400px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={chartData} margin={{ top: 20, right: 40, left: 10, bottom: 10 }}>
                    <CartesianGrid strokeDasharray="5 5" vertical={false} stroke="#faedcd" />
                    <XAxis dataKey="displayDate" dy={20} axisLine={false} tickLine={false} style={{fontSize: '16px'}} />
                    <YAxis width={70} axisLine tickLine domain={['dataMin - 10', 'dataMax + 10']} style={{fontSize: '16px'}} />
                    <Tooltip contentStyle={{ borderRadius: '30px', border: '3px dashed #faedcd', backgroundColor: '#fefae0', fontSize: '18px' }} />
                    {MEMBERS.map(m => (
                      <Fragment key={m.id}>
                        <Line type="monotone" dataKey={`${m.id}_systolic`} name={`${m.name}æ”¶ç¸®å£“`} stroke={m.color} strokeWidth={7} dot={{ r: 8, fill: '#fff', strokeWidth: 3 }} connectNulls strokeLinecap="round" />
                        <Line type="monotone" dataKey={`${m.id}_diastolic`} name={`${m.name}èˆ’å¼µå£“`} stroke={m.color} strokeWidth={3} strokeDasharray="8 8" dot={{ r: 7 }} connectNulls strokeLinecap="round" />
                      </Fragment>
                    ))}
                    <ReferenceLine y={140} stroke="#d4a373" strokeDasharray="8 8" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* ä¸‹æ’ï¼šå¿ƒè·³èˆ‡é«”é‡ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
              <div className="bg-white p-12 rounded-[4rem] shadow-sm border border-[#faedcd]/50 space-y-10 transition-all hover:shadow-2xl relative overflow-hidden">
                <div className="flex items-center gap-6 border-b-2 border-dotted border-[#faedcd] pb-6 text-[#d4a373]">
                  <Activity size={40} />
                  <h3 className="text-xl text-[#a98467] font-normal">å¿ƒè·³æ³¢å‹• (bpm)</h3>
                </div>
                <div className="h-[280px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={chartData} margin={{ top: 15, right: 30, left: 10, bottom: 10 }}>
                      <CartesianGrid strokeDasharray="5 5" vertical={false} stroke="#faedcd" />
                      <XAxis dataKey="displayDate" style={{fontSize: '16px'}} />
                      <YAxis width={70} domain={[40, 120]} style={{fontSize: '16px'}} />
                      {MEMBERS.map(m => (
                        <Line key={m.id} type="monotone" dataKey={`${m.id}_heartRate`} name={m.name} stroke={m.color} strokeWidth={7} dot={{ r: 8 }} connectNulls strokeLinecap="round" />
                      ))}
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-white p-12 rounded-[4rem] shadow-sm border border-[#faedcd]/50 space-y-10 transition-all hover:shadow-2xl relative overflow-hidden">
                <div className="flex items-center gap-6 border-b-2 border-dotted border-[#faedcd] pb-6 text-[#d4a373]">
                  <Scale size={40} />
                  <h3 className="text-xl text-[#a98467] font-normal">é«”é‡è®Šå‹• (kg)</h3>
                </div>
                <div className="h-[280px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={chartData} margin={{ top: 15, right: 30, left: 10, bottom: 10 }}>
                      <CartesianGrid strokeDasharray="5 5" vertical={false} stroke="#faedcd" />
                      <XAxis dataKey="displayDate" style={{fontSize: '16px'}} />
                      <YAxis width={70} domain={['auto', 'auto']} style={{fontSize: '16px'}} />
                      {MEMBERS.map(m => (
                        <Line key={m.id} type="monotone" dataKey={`${m.id}_weight`} name={m.name} stroke={m.color} strokeWidth={7} dot={{ r: 8 }} connectNulls strokeLinecap="round" />
                      ))}
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      {/* è¼¸å…¥è¦–çª— */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-8 bg-[#6b705c]/40 backdrop-blur-md">
          <div className="bg-white rounded-[5rem] w-full max-w-4xl max-h-[95vh] overflow-y-auto shadow-2xl border-4 border-white outline outline-4 outline-[#faedcd] animate-in zoom-in duration-300">
            <div className="p-12 sm:p-16">
              <div className="flex justify-between items-center mb-14 text-[#6b705c]">
                <div>
                  <h2 className="text-5xl tracking-tight underline decoration-[#faedcd] decoration-4 text-[#a98467] font-normal">å½©è‰²å°ç­†è¨˜ ğŸŒ³</h2>
                  <p className="text-[#d4a373] text-2xl mt-4 italic font-normal underline decoration-dotted">{selectedDate}</p>
                </div>
                <button onClick={() => setIsModalOpen(false)} className="p-6 bg-[#f5f2e9] text-[#ccd5ae] rounded-[2.5rem] hover:scale-110 active:rotate-90 transition-all outline-none font-normal">
                  <X size={64} />
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-16">
                <div className="grid grid-cols-3 gap-8">
                  {MEMBERS.map(m => (
                    <button key={m.id} type="button" onClick={() => setFormData({...formData, memberId: m.id})}
                      className={`py-8 rounded-[3rem] border-2 text-2xl transition-all ${formData.memberId === m.id ? `border-[#a98467] ${m.bgColor} ${m.text} shadow-2xl scale-105 ring-8 ring-[#faedcd]/50` : `bg-[#f5f2e9] text-[#ccd5ae]`}`}>
                      {m.name}
                    </button>
                  ))}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 text-[#6b705c]">
                  <div className="space-y-10">
                    <label className="block text-lg text-[#ccd5ae] uppercase italic font-normal">å°±è¨ºèˆ‡ç‹€æ³æè¿°</label>
                    <input type="text" value={formData.hospital} onChange={e => setFormData({...formData, hospital: e.target.value})} className="w-full px-10 py-8 bg-[#f5f2e9] rounded-[3rem] outline-none text-2xl shadow-inner placeholder:text-[#ccd5ae] font-normal" placeholder="é†«é™¢åç¨±" />
                    <input type="text" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} className="w-full px-10 py-8 bg-[#f5f2e9] rounded-[3rem] outline-none text-2xl shadow-inner placeholder:text-[#ccd5ae] font-normal" placeholder="ç§‘åˆ¥" />
                    <textarea value={formData.problem} onChange={e => setFormData({...formData, problem: e.target.value})} className="w-full px-10 py-8 bg-[#f5f2e9] rounded-[3rem] outline-none h-[220px] text-2xl shadow-inner placeholder:text-[#ccd5ae] font-normal" placeholder="æè¿°ä¸€ä¸‹æ„Ÿè¦º..."></textarea>
                  </div>
                  
                  <div className="space-y-12">
                    <div className="bg-[#fefae0] p-12 rounded-[4rem] border-2 border-dashed border-[#faedcd] space-y-10 shadow-sm">
                      <h3 className="text-lg text-[#d4a373] uppercase tracking-widest flex items-center gap-4 font-normal">ğŸ èº«é«”æ•¸å­—</h3>
                      <div className="grid grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm"><label className="text-base text-[#ccd5ae] block mb-3 text-center font-normal">æ”¶ç¸®å£“</label><input type="number" value={formData.systolic} onChange={e => setFormData({...formData, systolic: e.target.value})} className="w-full text-[#a98467] outline-none text-4xl text-center font-normal" /></div>
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm"><label className="text-base text-[#ccd5ae] block mb-3 text-center font-normal">èˆ’å¼µå£“</label><input type="number" value={formData.diastolic} onChange={e => setFormData({...formData, diastolic: e.target.value})} className="w-full text-[#a98467] outline-none text-4xl text-center font-normal" /></div>
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm"><label className="text-base text-[#ccd5ae] block mb-3 text-center font-normal">å¿ƒè·³</label><input type="number" value={formData.heartRate} onChange={e => setFormData({...formData, heartRate: e.target.value})} className="w-full text-[#a98467] outline-none text-4xl text-center font-normal" /></div>
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm"><label className="text-base text-[#ccd5ae] block mb-3 text-center font-normal">é«”é‡</label><input type="number" step="0.1" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} className="w-full text-[#a98467] outline-none text-4xl text-center font-normal" /></div>
                      </div>
                    </div>
                    <div className="bg-[#e9edc9]/40 p-12 rounded-[4rem] border-2 border-dashed border-[#ccd5ae] space-y-10 shadow-sm">
                      <h3 className="text-lg text-[#6b705c] uppercase tracking-widest flex items-center gap-4 font-normal">ğŸ¥¨ è—¥ç‰©ç´€éŒ„</h3>
                      <input type="text" value={formData.medication} onChange={e => setFormData({...formData, medication: e.target.value})} className="w-full px-10 py-8 bg-white rounded-[3rem] outline-none text-2xl shadow-sm placeholder:text-slate-300 font-normal" placeholder="è—¥å“åç¨±" />
                      <div className="grid grid-cols-2 gap-8">
                        <input type="text" value={formData.frequency} onChange={e => setFormData({...formData, frequency: e.target.value})} className="w-full px-10 py-8 bg-white rounded-[3rem] outline-none text-2xl shadow-sm placeholder:text-[#ccd5ae] font-normal" placeholder="é »ç‡" />
                        <input type="text" value={formData.medDuration} onChange={e => setFormData({...formData, medDuration: e.target.value})} className="w-full px-10 py-8 bg-white rounded-[3rem] outline-none text-2xl shadow-sm placeholder:text-[#ccd5ae] font-normal" placeholder="æœŸé™" />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex gap-10 pt-10">
                  {editingRecord && (
                    <button type="button" onClick={() => handleDelete(editingRecord.id)} className="p-10 bg-[#f5f2e9] text-[#ccd5ae] rounded-[3.5rem] hover:bg-red-50 hover:text-red-400 transition-all hover:scale-105 shadow-sm active:scale-95 outline-none font-normal">
                      <Trash2 size={56} />
                    </button>
                  )}
                  <button type="submit" className="flex-1 py-10 bg-[#d4a373] text-white text-4xl rounded-[3.5rem] shadow-xl hover:bg-[#a98467] active:scale-95 transition-all text-nowrap outline-none font-normal text-center">
                    è“‹ç« å„²å­˜ç´€éŒ„ ğŸ‚
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* å…¨åŸŸ CSS å­—é«”è¨­å®š */}
      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400&family=Noto+Sans+TC:wght@400&display=swap');
        
        .cute-font {
          font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif !important;
        }

        /* çµ•å°ç§»é™¤ç²—é«” */
        h1, h2, h3, h4, span, div, p, button, input, textarea {
          font-weight: 400 !important;
        }

        @keyframes bounce-slow {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-8px); }
        }
        .animate-bounce-slow { animation: bounce-slow 4s infinite ease-in-out; }
        @keyframes spin-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 30s linear infinite; }
      `}} />
    </div>
  );
}
